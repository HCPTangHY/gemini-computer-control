<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geminiè®¡ç®—æœºæ§åˆ¶ - æˆªå›¾æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .preview-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        .preview-title {
            color: #555;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .image-container {
            position: relative;
            display: none;
            margin-bottom: 15px;
        }

        #screenshotPreview {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: block;
        }

        #clickCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            display: none;
            margin-top: 15px;
        }

        .result-box.success {
            background: #d4edda;
            border: 2px solid #c3e6cb;
        }

        .result-box.error {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
        }

        .result-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .result-content {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #555;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.online {
            background: #28a745;
            box-shadow: 0 0 8px #28a745;
        }

        .status-indicator.offline {
            background: #dc3545;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– Geminiè®¡ç®—æœºæ§åˆ¶</h1>
        <p class="subtitle">åŸºäºGemini AIçš„å±å¹•åˆ†æä¸è‡ªåŠ¨ç‚¹å‡»ç³»ç»Ÿ</p>

        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
            <a href="playwright_sandbox.html" style="text-decoration: none; color: #667eea; font-weight: bold;">ğŸŒ æµè§ˆå™¨æ²™ç›’</a>
            <span style="color: #ccc;">|</span>
            <a href="real_computer_sandbox.html" style="text-decoration: none; color: #ff9a9e; font-weight: bold;">ğŸ–¥ï¸ çœŸå®ç”µè„‘æ²™ç›’</a>
        </div>

        <div class="info-box">
            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
            1. é€‰æ‹©æ“ä½œæ¨¡å¼ï¼š<strong>æµè§ˆå™¨æ¨¡å¼</strong> (Playwright) æˆ– <strong>çœŸå®ç”µè„‘æ¨¡å¼</strong> (PyAutoGUI)<br>
            2. ç‚¹å‡»"æˆªå–å±å¹•"æŒ‰é’®è¿›è¡Œæˆªå›¾<br>
            3. è¾“å…¥æŒ‡ä»¤ï¼ˆå¯é€‰ï¼‰ï¼Œç„¶åç‚¹å‡»"å‘é€ç»™AIåˆ†æ"<br>
            4. AIå°†è¿”å›å»ºè®®çš„æ“ä½œå¹¶è‡ªåŠ¨æ‰§è¡Œï¼ˆåœ¨çœŸå®ç”µè„‘æ¨¡å¼ä¸‹ï¼‰
        </div>

        <div class="control-panel">
            <div class="input-group">
                <label for="controlMode">æ“ä½œæ¨¡å¼</label>
                <select id="controlMode" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    <option value="browser">æµè§ˆå™¨æ¨¡å¼ (Playwright)</option>
                    <option value="real">çœŸå®ç”µè„‘æ¨¡å¼ (PyAutoGUI)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="backendUrl">
                    <span class="status-indicator offline" id="statusIndicator"></span>
                    åç«¯æœåŠ¡åœ°å€
                </label>
                <input 
                    type="text" 
                    id="backendUrl" 
                    value="http://localhost:5000"
                    placeholder="http://localhost:5000"
                >
            </div>

            <div class="input-group">
                <label for="instruction">AIæŒ‡ä»¤ï¼ˆå¯é€‰ï¼‰</label>
                <textarea 
                    id="instruction" 
                    placeholder="ä¾‹å¦‚ï¼šç‚¹å‡»å±å¹•ä¸­å¤®çš„æŒ‰é’®"
                ></textarea>
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="captureScreen()">
                    ğŸ“¸ æˆªå–å±å¹•
                </button>
                <button class="btn-primary" id="analyzeBtn" onclick="analyzeScreenshot()" disabled>
                    ğŸš€ å‘é€ç»™AIåˆ†æ
                </button>
            </div>
        </div>

        <div class="preview-section">
            <div class="preview-title">æˆªå›¾é¢„è§ˆ</div>
            <div class="image-container" id="imageContainer">
                <img id="screenshotPreview" alt="æˆªå›¾é¢„è§ˆ">
                <canvas id="clickCanvas"></canvas>
            </div>
            
            <div id="resultBox" class="result-box">
                <div class="result-title">AIåˆ†æç»“æœ</div>
                <div class="result-content" id="resultContent"></div>
            </div>
        </div>
    </div>

    <script>
        let currentScreenshot = null;
        let screenshotWidth = 0;
        let screenshotHeight = 0;
        let normalizedX = 0;
        let normalizedY = 0;

        // æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
        async function checkBackendStatus() {
            const url = document.getElementById('backendUrl').value;
            const indicator = document.getElementById('statusIndicator');
            
            try {
                const response = await fetch(`${url}/health`);
                if (response.ok) {
                    indicator.classList.remove('offline');
                    indicator.classList.add('online');
                    return true;
                }
            } catch (error) {
                console.error('åç«¯æœåŠ¡è¿æ¥å¤±è´¥:', error);
            }
            
            indicator.classList.remove('online');
            indicator.classList.add('offline');
            return false;
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥åç«¯çŠ¶æ€
        window.addEventListener('load', () => {
            checkBackendStatus();
            // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
            setInterval(checkBackendStatus, 5000);
        });

        // ç»˜åˆ¶ç‚¹å‡»æ ‡è®°
        function drawClickMarker(x, y, reasoning, normalized_x, normalized_y) {
            const preview = document.getElementById('screenshotPreview');
            const canvas = document.getElementById('clickCanvas');
            const container = document.getElementById('imageContainer');
            
            // è®¾ç½®canvaså°ºå¯¸ä¸å›¾ç‰‡ä¸€è‡´
            canvas.width = preview.offsetWidth;
            canvas.height = preview.offsetHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆä»å®é™…å±å¹•å°ºå¯¸åˆ°æ˜¾ç¤ºå°ºå¯¸ï¼‰
            const scaleX = preview.offsetWidth / screenshotWidth;
            const scaleY = preview.offsetHeight / screenshotHeight;
            
            // è½¬æ¢åæ ‡ï¼ˆx, yå·²ç»æ˜¯å®é™…åƒç´ åæ ‡ï¼‰
            const displayX = x * scaleX;
            const displayY = y * scaleY;
            
            // ä¿å­˜å½’ä¸€åŒ–åæ ‡
            normalizedX = normalized_x;
            normalizedY = normalized_y;
            
            // ç»˜åˆ¶å¤–åœˆï¼ˆçº¢è‰²ï¼‰
            ctx.beginPath();
            ctx.arc(displayX, displayY, 20, 0, 2 * Math.PI);
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // ç»˜åˆ¶å†…åœˆï¼ˆç™½è‰²ï¼‰
            ctx.beginPath();
            ctx.arc(displayX, displayY, 15, 0, 2 * Math.PI);
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // ç»˜åˆ¶ä¸­å¿ƒç‚¹
            ctx.beginPath();
            ctx.arc(displayX, displayY, 5, 0, 2 * Math.PI);
            ctx.fillStyle = '#ff0000';
            ctx.fill();
            
            // ç»˜åˆ¶åå­—çº¿
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(displayX - 25, displayY);
            ctx.lineTo(displayX + 25, displayY);
            ctx.moveTo(displayX, displayY - 25);
            ctx.lineTo(displayX, displayY + 25);
            ctx.stroke();
            
            // ç»˜åˆ¶åæ ‡æ–‡æœ¬èƒŒæ™¯
            const text = `åƒç´ : (${x}, ${y})`;
            const normText = `å½’ä¸€åŒ–: (${normalized_x}, ${normalized_y})`;
            ctx.font = 'bold 12px Arial';
            const textWidth = Math.max(ctx.measureText(text).width, ctx.measureText(normText).width);
            const textX = displayX + 30;
            const textY = displayY - 20;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(textX - 5, textY - 16, textWidth + 10, 40);
            
            // ç»˜åˆ¶åæ ‡æ–‡æœ¬
            ctx.fillStyle = '#ffffff';
            ctx.fillText(text, textX, textY);
            ctx.fillText(normText, textX, textY + 16);
            
            // å¦‚æœæœ‰reasoningï¼Œä¹Ÿæ˜¾ç¤º
            if (reasoning) {
                const reasonText = reasoning.length > 30 ? reasoning.substring(0, 30) + '...' : reasoning;
                ctx.font = '12px Arial';
                const reasonWidth = ctx.measureText(reasonText).width;
                const reasonX = displayX + 30;
                const reasonY = displayY + 15;
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(reasonX - 5, reasonY - 14, reasonWidth + 10, 20);
                
                ctx.fillStyle = '#ffff00';
                ctx.fillText(reasonText, reasonX, reasonY);
            }
        }

        // æˆªå–å±å¹•
        async function captureScreen() {
            const mode = document.getElementById('controlMode').value;
            const backendUrl = document.getElementById('backendUrl').value;

            if (mode === 'real') {
                // çœŸå®ç”µè„‘æ¨¡å¼ï¼šä»åç«¯è·å–æˆªå›¾
                try {
                    const response = await fetch(`${backendUrl}/real/screenshot`);
                    const data = await response.json();
                    if (data.success) {
                        currentScreenshot = data.screenshot;
                        screenshotWidth = data.width;
                        screenshotHeight = data.height;
                        
                        displayScreenshot();
                        alert('âœ… æˆåŠŸä»åç«¯è·å–çœŸå®å±å¹•æˆªå›¾ï¼');
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('è·å–åç«¯æˆªå›¾å¤±è´¥:', error);
                    alert('âŒ è·å–åç«¯æˆªå›¾å¤±è´¥: ' + error.message);
                }
            } else {
                // æµè§ˆå™¨æ¨¡å¼ï¼šä½¿ç”¨æµè§ˆå™¨ API æˆªå›¾
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: { mediaSource: 'screen' }
                    });

                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();

                    await new Promise(resolve => { video.onloadedmetadata = resolve; });

                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    screenshotWidth = canvas.width;
                    screenshotHeight = canvas.height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);

                    stream.getTracks().forEach(track => track.stop());
                    currentScreenshot = canvas.toDataURL('image/png');

                    displayScreenshot();
                    alert('âœ… æµè§ˆå™¨æˆªå›¾æˆåŠŸï¼');
                } catch (error) {
                    console.error('æµè§ˆå™¨æˆªå›¾å¤±è´¥:', error);
                    alert('âŒ æµè§ˆå™¨æˆªå›¾å¤±è´¥: ' + error.message);
                }
            }
        }

        function displayScreenshot() {
            const preview = document.getElementById('screenshotPreview');
            const container = document.getElementById('imageContainer');
            const clickCanvas = document.getElementById('clickCanvas');
            
            preview.src = currentScreenshot;
            container.style.display = 'block';
            
            const ctx2 = clickCanvas.getContext('2d');
            ctx2.clearRect(0, 0, clickCanvas.width, clickCanvas.height);

            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('resultBox').style.display = 'none';
        }

        // å‘é€æˆªå›¾ç»™AIåˆ†æ
        async function analyzeScreenshot() {
            if (!currentScreenshot) {
                alert('è¯·å…ˆæˆªå–å±å¹•ï¼');
                return;
            }

            const backendUrl = document.getElementById('backendUrl').value;
            const instruction = document.getElementById('instruction').value;
            const analyzeBtn = document.getElementById('analyzeBtn');
            const resultBox = document.getElementById('resultBox');
            const resultContent = document.getElementById('resultContent');

            // æ£€æŸ¥åç«¯çŠ¶æ€
            const isOnline = await checkBackendStatus();
            if (!isOnline) {
                alert('âŒ åç«¯æœåŠ¡æœªè¿æ¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼');
                return;
            }

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = 'ğŸ”„ åˆ†æä¸­<span class="loading"></span>';

            try {
                const response = await fetch(`${backendUrl}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: currentScreenshot,
                        screen_width: screenshotWidth,
                        screen_height: screenshotHeight,
                        instruction: instruction || 'è¯·åˆ†æè¿™å¼ æˆªå›¾ï¼Œæ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ä½ç½®è¿›è¡Œç‚¹å‡»ã€‚'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    resultBox.className = 'result-box success';
                    resultBox.style.display = 'block';
                    resultContent.textContent = JSON.stringify(data, null, 2);
                    
                    const mode = document.getElementById('controlMode').value;
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å¤šå·¥å…·è°ƒç”¨
                    if (data.type === 'multiple_function_calls') {
                        // å¤šå·¥å…·è°ƒç”¨
                        let message = `âœ… AIè¿”å›äº† ${data.count} ä¸ªæ“ä½œæ­¥éª¤ï¼š\n\n`;
                        
                        for (const result of data.results) {
                            if (result.success) {
                                // å¦‚æœæ˜¯çœŸå®ç”µè„‘æ¨¡å¼ï¼Œè‡ªåŠ¨æ‰§è¡Œæ“ä½œ
                                if (mode === 'real') {
                                    await executeRealAction(result);
                                }
                            }
                        }
                        
                        data.results.forEach((result, index) => {
                            const step = index + 1;
                            if (result.success) {
                                message += `æ­¥éª¤${step}: ${result.function_name}\n`;
                                if (result.action === 'click') {
                                    message += `  - ç‚¹å‡»åæ ‡: (${result.x}, ${result.y})\n`;
                                } else if (result.action === 'type') {
                                    message += `  - è¾“å…¥æ–‡æœ¬: "${result.text.substring(0, 30)}..."\n`;
                                }
                                message += `  - åŸå› : ${result.reasoning}\n\n`;
                            }
                        });
                        
                        // æ ‡è®°ç¬¬ä¸€ä¸ªæ“ä½œ
                        const firstResult = data.results[0];
                        if (firstResult.success && (firstResult.action === 'click' || firstResult.action === 'hover')) {
                            drawClickMarker(firstResult.x, firstResult.y, `æ­¥éª¤1: ${firstResult.reasoning}`, firstResult.normalized_x || firstResult.x, firstResult.normalized_y || firstResult.y);
                        }
                        
                        alert(message + (mode === 'real' ? "\nâš¡ æ‰€æœ‰æ“ä½œå·²åœ¨çœŸå®ç”µè„‘ä¸Šæ‰§è¡Œï¼" : ""));
                    } else {
                        // å•å·¥å…·è°ƒç”¨
                        if (mode === 'real') {
                            await executeRealAction(data);
                        }

                        if ((data.action === 'click' || data.action === 'hover') && data.x !== undefined && data.y !== undefined) {
                            drawClickMarker(data.x, data.y, data.reasoning, data.normalized_x || data.x, data.normalized_y || data.y);
                        }
                        
                        alert(`âœ… AIåˆ†ææˆåŠŸï¼${mode === 'real' ? "\nâš¡ æ“ä½œå·²åœ¨çœŸå®ç”µè„‘ä¸Šæ‰§è¡Œï¼" : ""}`);
                    }
                } else {
                    resultBox.className = 'result-box error';
                    resultBox.style.display = 'block';
                    resultContent.textContent = `é”™è¯¯: ${data.error}`;
                    
                    alert('âŒ AIåˆ†æå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                resultBox.className = 'result-box error';
                resultBox.style.display = 'block';
                resultContent.textContent = `ç½‘ç»œé”™è¯¯: ${error.message}`;
                
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = 'ğŸš€ å‘é€ç»™AIåˆ†æ';
            }
        }

        async function executeRealAction(action) {
            const backendUrl = document.getElementById('backendUrl').value;
            try {
                const response = await fetch(`${backendUrl}/real/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action })
                });
                return await response.json();
            } catch (error) {
                console.error('æ‰§è¡ŒçœŸå®æ“ä½œå¤±è´¥:', error);
            }
        }
    </script>
</body>
</html>